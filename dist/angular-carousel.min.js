/**
 * Angular Carousel - Mobile friendly touch carousel for AngularJS
 * @version v0.0.9 - 2013-12-30
 * @link http://revolunet.github.com/angular-carousel
 * @author Julien Bouquillon <julien@revolunet.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
angular.module("angular-carousel",["ngTouch"]).config(["$provide",function(a){a.decorator("$rootScope",["$delegate",function(a){return a.safeApply=function(b){var c=a.$$phase;"$apply"===c||"$digest"===c?b&&"function"==typeof b&&b():a.$apply(b)},a}])}]),angular.module("angular-carousel").directive("rnCarouselIndicators",["$rootScope","$timeout",function(a,b){return{restrict:"A",replace:!0,scope:{items:"=",index:"="},template:'<div class="rn-carousel-indicator"><span ng-repeat="item in items" ng-class="{active: $index==$parent.index}" ng-click="select($event, $index)">&bull;</span></div>',link:function(c,d){var e;b(function(){e=d.parent().attr("id")},300),c.select=function(b,c){b&&b.stopPropagation(),a.$broadcast("angularCarousel:select",e,c)}}}}]),angular.module("angular-carousel").directive("rnCarouselInfinite",["$parse","$compile",function(a){return{restrict:"EA",transclude:!0,replace:!0,scope:!0,template:"<ul rn-carousel rn-carousel-buffered><li ng-transclude></li></ul>",compile:function(b,c){var d=c.rnCarouselCurrent+" in items";return b.children("li").attr("ng-repeat",d),function(b,c,d){b.items=[a(d.rnCarouselCurrent)(b)],b.$watchCollection("carouselCollection.position",function(c){a(d.rnCarouselCurrent).assign(b.$parent,b.items[c])})}}}}]),angular.module("angular-carousel").directive("rnCarousel",["$rootScope","$compile","$parse","$swipe","$document","$window","CollectionManager",function(a,b,c,d,e,f,g){var h=0;return{restrict:"A",scope:!0,compile:function(i,j){i.addClass("rn-carousel-slides");var k,l,m=i.children("li")[0].attributes,n=m["ng-repeat"],o=!1;if(n||(n=m["data-ng-repeat"]),n||(n=m["x-ng-repeat"]),n){var p=n.value.match(/^\s*(.+)\s+in\s+(.*?)\s*(\s+track\s+by\s+(.+)\s*)?$/),q=p[1],r=p[3]||"";k=p[2],o=angular.isDefined(j.rnCarouselBuffered),n.value=q+" in carouselCollection.cards "+r}else{var s=i.children("li");if(s.length<2)throw new Error("carousel: cannot find the ngRepeat attribute OR no childNodes detected");k="fakeArray",l=Array.prototype.slice.apply(s)}return function(i,j,m){function n(a){var b=angular.element(a).css("transform").match(/translate3d\((-?\d+(?:px)?),\s*(-?\d+(?:px)?),\s*(-?\d+(?:px)?)\)/);return b?b.slice(1,3):[0,0,0]}function p(b){!b.target||b.target!==J[0]||"transform"!==b.propertyName&&"-webkit-transform"!==b.propertyName&&"-moz-transform"!==b.propertyName||(a.safeApply(function(){s(),i.carouselCollection.adjustBuffer(),x(!0)}),J.css(u(n(J[0]),!0)))}function q(b,c){function d(){I=!0,i.carouselCollection[b](c,!0)}a.safeApply(function(){d()})}function r(a,b){var c="after"===a?"push":"unshift";b&&(angular.isObject(b.promise)?b.promise.then(function(a){a&&q(c,a)}):angular.isFunction(b.then)?b.then(function(a){a&&q(c,a)}):q(c,b))}function s(){var a=i.carouselCollection.position,b=i.carouselCollection.getLastIndex(),d=null;0===a&&angular.isDefined(m.rnCarouselPrev)&&(d=c(m.rnCarouselPrev)(i,{item:i.carouselCollection.cards[0]}),r("before",d)),a===b&&angular.isDefined(m.rnCarouselNext)&&(d=c(m.rnCarouselNext)(i,{item:i.carouselCollection.cards[i.carouselCollection.cards.length-1]}),r("after",d))}function t(a,b){var c={};return c[a]=b,angular.forEach(Q,function(d){c["-"+d.toLowerCase()+"-"+a]=b}),c}function u(a,b){return b?t("transform","translate3d("+a+"px,0,0)"):t("transform","translate("+a+"px,0)")}function v(){w(),x()}function w(){K.css("width","auto"),I=!0;var a=J.children("li");return H=0===a.length?J[0].getBoundingClientRect().width:a[0].getBoundingClientRect().width,K.css("width",H+"px"),H}function x(a){I=!!a||I,0===H&&w(),F=Math.round(i.carouselCollection.getRelativeIndex()*-H),I===!0?J.removeClass("rn-carousel-animate").addClass("rn-carousel-noanimate").css(u(F,!1)):J.removeClass("rn-carousel-noanimate").addClass("rn-carousel-animate").css(u(F,!0)),I=!1}function y(b){if(e.unbind("mouseup",A),0===H&&w(),C>1){var c=i.carouselCollection.getLastIndex(),d=i.carouselCollection.position,f=E>F?1:-1,g=Math.min(Math.max(0,d+f),c),h=b.x-D;Math.abs(h)<=H*G&&(g=d);var j=d!==g;j?a.safeApply(function(){angular.isDefined(m.rnCarouselCycle)&&(i.carouselCollection.position=g,x()),i.carouselCollection.goTo(g,!0)}):a.safeApply(function(){x()})}C=0}function z(a){var b=K[0].getBoundingClientRect(),c=a.x>b.left&&a.x<b.left+H&&a.y>b.top&&a.y<b.top+b.height;return c}function A(a){y({x:a.clientX,y:a.clientY})}h++;var B="rn-carousel-"+h,C=0,D=0,E=0,F=0,G=.1,H=0,I=!0,J=j.wrap("<div id='"+B+"' class='rn-carousel-container'></div>"),K=J.parent();l&&(i.fakeArray=l);var L=c(k),M={},N=0;if(m.rnCarouselIndex){var O=c(m.rnCarouselIndex);angular.isFunction(O.assign)?(i.$watch("carouselCollection.index",function(a){O.assign(i.$parent,a)}),N=O(i),i.$parent.$watch(O,function(a){void 0!==a&&i.carouselCollection.goToIndex(a,!1)})):isNaN(m.rnCarouselIndex)||(N=parseInt(m.rnCarouselIndex,10))}angular.isDefined(m.rnCarouselCycle)&&(M.cycle=!0),M.index=N,o&&(M.bufferSize=3,M.buffered=!0),i.carouselCollection=g.create(M),i.$watch("carouselCollection.updated",function(a){a&&x()});var P=!1;i.$watch(L,function(a){i.carouselCollection.setItems(a,P),P=!0,0===H&&w(),x()}),angular.isDefined(m.rnCarouselWatch)&&i.$watch(k,function(a){i.carouselCollection.setItems(a,!1),P=!0,0===H&&w(),x()},!0);var Q=["webkit","moz"];if(J[0].addEventListener("webkitTransitionEnd",p,!1),J[0].addEventListener("transitionend",p,!1),window.addEventListener("orientationchange",v),window.addEventListener("resize",v),angular.isDefined(m.rnCarouselIndicator)){var R=b("<div id='"+B+"-indicator' index='carouselCollection.index' items='carouselCollection.items' data-rn-carousel-indicators class='rn-carousel-indicator'></div>")(i);K.append(R)}var S=null,T=f.jasmine||"iPad"==f.navigator.platform?0:50;d.bind(J,{start:function(a){0===C&&(C=1,D=a.x),e.bind("mouseup",A)},move:function(a){if(!z(a))return y(a),void 0;if(0!==C){var b=a.x-D;if(1===C&&0!==b)C=2,E=F;else if(2===C){var c=(new Date).getTime();if(S&&T>c-S)return;S=c;var d=i.carouselCollection.getLastIndex(),e=i.carouselCollection.position,f=1;(0===e&&a.x>D||e===d&&a.x<D)&&(f=3),F=E+b/f,J.css(u(F,!0)).removeClass("rn-carousel-animate").addClass("rn-carousel-noanimate")}}},end:function(a){y(a)}}),i.$on("angularCarousel:select",function(a,b,c){b==B&&i.carouselCollection.goToIndex(c)})}}}}]),angular.module("angular-carousel").service("CollectionManager",[function(){function a(a){var b,c={bufferSize:0,bufferStart:0,buffered:!1,cycle:!1,cycleOffset:0,index:0,position:0,items:[],cards:[],updated:null,debug:!1};if(a)for(b in a)c[b]=a[b];for(b in c)this[b]=c[b];angular.extend(this,c,a),this.init()}return a.prototype.log=function(){this.debug&&console.log.apply(console,arguments)},a.prototype.getPositionFromIndex=function(a){return(a+this.cycleOffset)%this.length()},a.prototype.goToIndex=function(a,b){if(a=Math.max(0,Math.min(a,this.getLastIndex())),this.updated&&a===this.index)return this.log("skip position change(same)"),!1;var c=this.getPositionFromIndex(a);return this.goTo(c,b)},a.prototype.goTo=function(a,b){if(this.log("goto start",a,b),0===this.length())return this.log("empty, skip gotoIndex"),void 0;a=Math.max(0,Math.min(a,this.getLastIndex()));var c=!1;this.cycle&&(0===a?(this.log("cycleAtBeginning",a),this.cycleAtBeginning(),a=1,this.cycleOffset++,c=!0):a===this.getLastIndex()&&(this.log("cycleAtEnd",a),this.cycleAtEnd(),a--,this.cycleOffset--,c=!0),this.cycleOffset%=this.length()),this.position=Math.max(0,Math.min(a,this.getLastIndex()));var d=(this.position-this.cycleOffset+this.length())%this.length();this.index=Math.max(0,Math.min(d,this.getLastIndex())),b||this.adjustBuffer(),c||(this.updated=new Date)},a.prototype.next=function(){this.cycle?this.goTo((this.position+1)%this.length()):this.goTo(Math.min(this.position+1,this.getLastIndex()))},a.prototype.prev=function(){if(this.cycle)this.goTo((this.position-1+this.length())%this.length());else{var a=this.length()>0?Math.max(0,(this.position-1)%this.length()):0;this.goTo(a)}},a.prototype.setBufferSize=function(a){this.log("setBufferSize",a),this.bufferSize=a,this.adjustBuffer()},a.prototype.isBuffered=function(){return this.buffered},a.prototype.getRelativeIndex=function(){var a=Math.max(0,Math.min(this.getLastIndex(),this.position-this.bufferStart));return a},a.prototype.adjustBuffer=function(){var a=(this.getLastIndex()+1-this.bufferSize)%this.length();this.log("maxBufferStart",a),this.bufferStart=Math.max(0,Math.min(a,this.position-1)),this.cards=this.items.slice(this.bufferStart,this.bufferStart+this.bufferSize),this.log("adjustBuffer from",this.bufferStart,"to",this.bufferStart+this.bufferSize)},a.prototype.length=function(){return this.items.length},a.prototype.getLastIndex=function(){var a=Math.max(0,this.length()-1);return a},a.prototype.init=function(){this.setBufferSize(this.isBuffered()?this.bufferSize:this.length()),this.length()>0&&this.goToIndex(this.index)},a.prototype.setItems=function(a,b){this.log("setItems",a,b),b&&(this.index=0,this.position=0),this.items=a||[],this.init()},a.prototype.cycleAtEnd=function(){this.push(this.items.shift())},a.prototype.push=function(a,b){this.log("push item(s)",a,b),this.items.push(a),b&&(this.adjustBuffer(),this.updated=new Date),this.buffered||this.bufferSize++},a.prototype.unshift=function(a,b){this.log("unshift item(s)",a,b),this.items.unshift(a),this.buffered||this.bufferSize++,b&&(this.position++,this.adjustBuffer(),this.updated=new Date)},a.prototype.cycleAtBeginning=function(){this.unshift(this.items.pop())},{create:function(b){return new a(b)}}}]);